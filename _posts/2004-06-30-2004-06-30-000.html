---
  title: "Content Creation with SMS"
  categories: 
    - "midgard"
  layout: "post"

---

<p>The SMSs are sent to an old <a href="http://www.mobileoffice.co.za/ericsson_r520.htm">Ericsson R520</a> mobile phone which is connected to a Linux box running <a href="http://www.pxh.de/fs/gsmlib/doc/gsmsmsd.html">gsmsmsd</a> from <a href="http://www.pxh.de/fs/gsmlib/">gsmlib</a>. New SMSs are forwarded to Routa MC as emails, which are imported into <a href="http://www.midgard-project.org/">Midgard</a> using <a href="http://catb.org/~esr/fetchmail/">fetchmail</a> and the <a href="http://www.openpsa.org/">OpenPSA</a> mail import script <a href="http://openpsa.tigris.org/source/browse/openpsa/src/supportmda.pl?rev=1.2&content-type=text/vnd.viewcvs-markup">supportmda.pl</a>.<br /></p>
<p>Then the SMSs are handled by a Midgard page which has the following code:<br />

</p>
<pre>&lt;?php<br />/*<br />Routa MC Travel Journals<br />SMS logbook upload handler<br /><br />Henri Bergius &lt;henri.bergius@iki.fi&gt;<br /><br />Based on snippet /TechSupport/UI/Handlers/Email-import<br />from OpenPSA (www.openpsa.org)<br /><br />2004-06-30: Adapted from the Paska-G:n Sprintti upload handled (bergie)<br /><br />Each topic to be handled by this system must have parameters<br />RoutaSMS/number/name set for matching the incoming SMSs to<br />articles and authors.<br /><br />If notifications are required, they are handled by adding<br />parameters in format RoutaSMSsubscribe/name/email to the<br />root topic.<br /><br />Note: the mail transfer agent expects to receive uppercase<br />OK when the mail has been successfully processed. If that is<br />missing or uppercase ERROR has been transmitted the email<br />will not be removed from server.<br />*/<br /><br />// GUID to the topic where log topics reside<br />$routasms_topic_guid = &quot;c4b2f1bead1f8a25f4c553ef4fe5a546&quot;;<br /><br />// GUID of article where unrecognized messages are sent or NULL <br />$routasms_misc_article = null;<br /><br />// User account for updating log articles<br />$routasms_username = &quot;USERNAME&quot;;<br />$routasms_password = &quot;PASSWORD&quot;;<br /><br />// SMS receiver email address to remove from messages<br />$routasms_email_receive = &quot;gateway@myorganization.org&quot;;<br /><br />// Whether to enable email notifications<br />$routasms_notifications_enabled = true;<br />$routasms_notifications = array();<br /><br />// Start buffering for the log<br />header(&quot;Content-type:text/plain&quot;);<br />ob_start();<br />echo &quot;=================================================\n&quot;;<br />echo &quot;DEBUG: Started email handling on &quot;.date(&quot;Y-m-d H:i&quot;,time()).&quot;\n&quot;;<br />echo &quot;DEBUG: User-Agent: &quot;.$_SERVER['HTTP_USER_AGENT'].&quot;\n&quot;;<br /><br />// Load the log topic<br />$routasms_topic = mgd_get_object_by_guid($routasms_topic_guid);<br />echo &quot;DEBUG: Loaded topic &quot;.$routasms_topic-&gt;name.&quot; (#&quot;.$routasms_topic-&gt;id.&quot;)\n&quot;;<br /><br />// Function for logging the output<br />function routasms_log() {<br />  $data = ob_get_contents();<br />  //write the contents to a file<br />  $fp = fopen(&quot;/tmp/routasms-upload.log&quot;,&quot;a&quot;);<br />  fwrite($fp,$data);<br />  fclose($fp);<br />  // Output the status<br />  ob_end_flush();<br />}<br /><br />// Don't bother to even initialize anything if we don't have anything to process<br />if (!$_REQUEST[&quot;mailbody&quot;]) { <br />   echo &quot;ERROR: No body received\n&quot;;<br />   routasms_log();<br />   exit();<br />} else {<br /><br />  // Check that we got the whole email<br />  echo &quot;DEBUG: got body, reported size=&quot;.$bodysize.&quot;b actual size=&quot;.strlen($mailbody).&quot;b\n&quot;;<br />  if ($_REQUEST[&quot;bodysize&quot;] != strlen($_REQUEST[&quot;mailbody&quot;])) {<br />    echo &quot;ERROR: Reported and actual bodysize different, transfer error ?\n&quot;;<br />    routasms_log();<br />    exit();<br />  }<br /><br />  // Load Mail class from OpenPSA<br />  mgd_include_snippet(&quot;/Nemeinnet_Core/Mail&quot;);<br /><br />  // Load NemeinRCS revision control script<br />  mgd_include_snippet(&quot;/AegirCore/config/config&quot;);<br />  global $rcsroot;<br />  $rcsroot = $set[&quot;rcsroot&quot;];<br />  if (!$rcsroot) {<br />    $rcsroot = &quot;/var/lib/aegir/cvs&quot;;<br />  }<br />  echo &quot;DEBUG: Set revision control root to &quot;.$rcsroot.&quot; (got &quot;.$set[&quot;rcsroot&quot;].&quot; from Aegir)\n&quot;;<br />  mgd_include_snippet(&quot;/AegirCore/lib/rcs_functions&quot;);<br /><br />  // Load NemeinJournal classes<br />  mgd_include_snippet(&quot;/NemeinJournal/Core/init&quot;);<br /><br />  // Authenticate the user if needed<br />  if (!$midgard-&gt;user) {<br />    mgd_auth_midgard($routasms_username, $routasms_password, 0);<br />    $midgard = mgd_get_midgard();<br />    if (!$midgard-&gt;user) {<br />      echo &quot;ERROR: No user authenticated (or authentication error)\n&quot;;<br />      routasms_log();<br />      exit();<br />    }<br />  }<br />  $user = mgd_get_person($midgard-&gt;user);<br />  echo &quot;DEBUG: Authenticated user &quot;.$user-&gt;name.&quot; (#&quot;.$midgard-&gt;user.&quot;)\n&quot;;<br /><br />  // Parse the email<br />  $mail=new nemeinnet_mail();<br />  $mail-&gt;body=$_REQUEST[&quot;mailbody&quot;];<br />  $mime=&amp;$mail-&gt;mimeDecode();<br />  echo &quot;DEBUG: decoded body size &quot;.strlen($mail-&gt;body).&quot;b\n&quot;;<br /><br />  // Get the sending phone number<br />  $name_preg=&quot;/[\&quot;']?([^&lt;@\&quot;']*)[\&quot;']?/&quot;;<br />  preg_match($name_preg, $mail-&gt;from, $name_matches);<br />  $routasms_number = preg_replace(&quot;/\.|_/&quot;, &quot; &quot;, $name_matches[1]);<br />  echo &quot;DEBUG: SMS sent by number &quot;.$routasms_number.&quot;\n&quot;;<br /><br />  // Get the log message<br />  $routasms_message = $mail-&gt;body;<br /><br />  // Remove receiver email address from message<br />  $routasms_message = str_replace($routasms_email_receive.&quot; &quot;,&quot;&quot;,$routasms_message);<br /><br />  // Get the log time<br />  // TODO: read from the email<br />  $routasms_time = time();<br /><br />  // Log article object<br />  $routasms_log = false;<br /><br />  // Name of the sender<br />  $routasms_sender = false;<br /><br />  // Load the log topics<br />  $log_topics = mgd_list_topics($routasms_topic-&gt;id);<br />  if ($log_topics) {<br />    while ($log_topics-&gt;fetch()) {<br /><br />      // Load phone numbers<br />      $number_params = $log_topics-&gt;listparameters(&quot;RoutaSMS&quot;);<br />      if ($number_params) {<br />        while ($number_params-&gt;fetch()) {<br /><br />          // Match with sending number<br />          if ($number_params-&gt;name == $routasms_number) {<br />            echo &quot;DEBUG: SMS number matched with topic &quot;.$log_topics-&gt;title.&quot; (#&quot;.$log_topics-&gt;id.&quot;)\n&quot;;<br />            $routasms_sender = $log_topics-&gt;parameter(&quot;RoutaSMS&quot;,$number_params-&gt;name);<br /><br />            $routasms_log_topic = mgd_get_topic($log_topics-&gt;id);<br /><br />            // Load notification subscriber list<br />            $notification_params = $routasms_log_topic-&gt;listparameters(&quot;RoutaSMSsubscribe&quot;);<br />            if ($notification_params) {<br />              while ($notification_params-&gt;fetch()) {<br />                $routasms_notifications[$notification_params-&gt;name] = $routasms_log_topic-&gt;parameter(&quot;RoutaSMSsubscribe&quot;,$notification_params-&gt;name);<br />              }<br />              echo &quot;DEBUG: Loaded &quot;.count($routasms_notifications).&quot; notification subscribers\n&quot;;<br />            }<br /><br />            // Check if sender wants to create new entry<br />            if (stristr(substr($routasms_message,0,6),&quot;NEWLOG&quot;)) {<br /><br />              // Read the title of the new entry<br />              $routasms_newlog_title = substr($routasms_message,7);<br />              echo &quot;DEBUG: Received NEWLOG command for entry \&quot;&quot;.$routasms_newlog_title.&quot;\&quot;\n&quot;;<br /><br />              // Create new NemeinJournal entry<br />              $routasms_newlog = new journal_entry();<br />              $routasms_newlog-&gt;topic = $routasms_log_topic-&gt;id;<br />              $routasms_newlog-&gt;title = $routasms_newlog_title;<br />              $routasms_newlog_id = $routasms_newlog-&gt;save();<br />              if ($routasms_newlog_id) {<br />                echo &quot;DEBUG: Created new NemeinJournal entry #&quot;.$routasms_newlog_id.&quot;\n&quot;;<br /><br />               // Send notifications on the new journal entry<br />               if ($routasms_notifications_enabled &amp;&amp; count($routasms_notifications)) {<br />                 foreach ($routasms_notifications as $name =&gt; $email) {<br />                   // Send the notification in format supported by Nemein's SMS gateway<br />                   mail('&quot;'.$name.'&quot; &lt;'.$email.'&gt;','New journal entry '.$routasms_log-&gt;title.' ('.$routasms_log_topic-&gt;name.') was created by '.$routasms_sender,$routasms_log_topic-&gt;name.&quot;: New entry \&quot;&quot;.substr($routasms_message,7).&quot;\&quot;&quot;,'From: &quot;'.$routasms_topic-&gt;extra.'&quot; &lt;'.$routasms_email_receive.'&gt;');<br />                   echo &quot;DEBUG: mailed notification to \&quot;&quot;.$name.&quot;\&quot; &lt;&quot;.$email.&quot;&gt;\n&quot;;<br />                 }<br />               }<br /><br /><br />                // Entry has been created, exit<br />                echo &quot;OK\n&quot;;<br />                routasms_log();<br />                exit();<br />              } else {<br />                echo &quot;ERROR: Failed to create NemeinJournal entry, reason &quot;.mgd_errstr().&quot;\n&quot;;<br />              }<br /><br />            } else {<br />              // Fetch the latest log entry article<br />              $log_topics_articles = mgd_list_topic_articles($routasms_log_topic-&gt;id);<br />              if ($log_topics_articles) {<br />                if ($log_topics_articles-&gt;fetch()) {<br />                  echo &quot;DEBUG: Loaded latest NemeinJournal entry #&quot;.$log_topics_articles-&gt;id.&quot;\n&quot;;<br />                  $routasms_log = new journal_entry($log_topics_articles-&gt;id);<br />                }<br />              } else {<br />                echo &quot;ERROR: No NemeinJournal entries found in topic\n&quot;;<br />                // TODO: create empty log item??<br />              }<br />            }<br />          }<br /><br />        }<br />      }<br /><br />    }<br />  } else {<br />    echo &quot;ERROR: No log topics under root topic\n&quot;;<br />    routasms_log();<br />    exit();<br />  }<br /><br />  // Load the misc article if possible<br />  if (!$routasms_log &amp;&amp; $routasms_misc_article) {<br />    echo &quot;DEBUG: SMS number didn't match, loading misc article\n&quot;;<br />    $routasms_log = mgd_get_object_by_guid($routasms_misc_article);<br />  }<br /><br />  // Default to sending number as sender name<br />  if (!$routasms_sender) {<br />    $routasms_sender = $routasms_number;<br />  }<br /><br />  // Store the message to the log<br />  if ($routasms_log) {<br />    // Start the message block<br />    $routasms_log-&gt;content .= &quot;&lt;p&gt;\n&quot;;<br />    // Store message<br />    $routasms_log-&gt;content .= $routasms_message;<br />    // Store date<br />    $routasms_log-&gt;content .= &quot;\n &lt;em&gt;(&quot;.date(&quot;Y-m-d H:i&quot;,$routasms_time);<br />    // Store sender<br />    $routasms_log-&gt;content .= &quot; - &quot;.$routasms_sender.&quot;)&lt;/em&gt;\n&quot;;<br />    // End the message block<br />    $routasms_log-&gt;content .= &quot;&lt;/p&gt;\n&quot;;<br />    // Save the log<br />    if (get_class($routasms_log) == &quot;journal_entry&quot;) {<br />      // NemeinJournal uses save() method instead of Midgard's standard update()<br />      $status = $routasms_log-&gt;save();<br />    } else {<br />      $status = $routasms_log-&gt;update();<br />    }<br />    if ($status) {<br /><br />      // Send notifications on the journal entry update<br />      if ($routasms_notifications_enabled &amp;&amp; count($routasms_notifications)) {<br />        foreach ($routasms_notifications as $name =&gt; $email) {<br />          // Send the notification in format supported by Nemein's SMS gateway<br />          mail('&quot;'.$name.'&quot; &lt;'.$email.'&gt;','Journal entry '.$routasms_log-&gt;title.' ('.$routasms_log_topic-&gt;name.') updated by '.$routasms_sender,$routasms_log_topic-&gt;name.&quot;: &quot;.$routasms_message,'From: &quot;'.$routasms_topic-&gt;extra.'&quot; &lt;'.$routasms_email_receive.'&gt;');<br />          echo &quot;DEBUG: mailed notification to \&quot;&quot;.$name.&quot;\&quot; &lt;&quot;.$email.&quot;&gt;\n&quot;;<br />        }<br />      }<br /><br />      // Update revision control information<br />      rcs_update($routasms_log);<br /><br />      // Message was saved successfully, say OK<br />      echo &quot;OK\n&quot;;<br /><br />    } else {<br />      echo &quot;ERROR: Failed to save log article, reason &quot;.mgd_errstr().&quot;\n&quot;;<br />    }<br />  } else {<br />    echo &quot;ERROR: No log article found\n&quot;;<br />    routasms_log();<br />    exit();<br />  }<br />}<br />// Log status<br />routasms_log();<br />?&gt;<br /></pre>

<p>The phone has had a <a href="http://www.kaukolaweb.com/blog/2004-06-12-000.html">tendency to crash</a>, but <a href="http://rambo.pbt-unknown.org/">Rambo</a> is looking to fix that.<br />

</p>