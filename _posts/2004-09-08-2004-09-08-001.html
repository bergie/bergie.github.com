---
  title: "Endorsing MidCOM's Migration to File System"
  categories: 
    - "midgard"
  layout: "post"

---
<h2>Current situation</h2>To those unfamiliar with Midgard development, <a href="http://www.midgard-project.org/framework/" title="The Midgard Framework">Midgard Framework</a> itself has been written as a C system library and a <a href="http://www.php.net/" title="The PHP programming language">PHP</a> extension. The Framework provides services like authentication, templating and content storage. The actual Midgard applications are written on that foundation in PHP and stored in the Midgard database as pages and "snippet" objects.<br /><br /><a href="http://www.midgard-project.org/projects/midcom/">MidCOM</a> functions as a component system written on the application layer. With MidCOM, the actual point applications, or components are written following a strict set of coding standards and stored in the Midgard snippet tree. The components must provide a standardized set of interfaces, and all input and output with them is controlled by the MidCOM framework.<br /><br />The fact that all application code is stored in the database causes several problems, the topmost being lack of good development tools and difficulty of version control. Torben explains these points well in the "Current problems" section of the mRFC.<br /><br />Additional issue is performance. A component framework is a big thing, and its services and interfaces require many code libraries to be loaded. It has been calculated that an average MidCOM page request causes 2000 database queries. With careful optimization we could probably get the number down to about 1300, but that is still a lot. If we move the libraries to file system, only database I/O will be actual content and template queries. Also, if the code is stored in the file system, it can be compiled into faster byte code using tools like Zend Optimizer.<br /><h2>Reasoning for the old way</h2>With all these issues, why did we do the illogical thing of putting our code into the database in the first place? The code snippet system was added to Midgard in the 1.4.0 cycle, and there were several reasons:<br /><ul><li>At that time most Midgard applications were much smaller</li><li>Storage in Midgard database provides metadata support. Licensing information, documentation and icons can be stored into the code objects themselves<br /></li><li>Code can be replicated together with the site data</li><li>Editing code does not require filesystem access</li><li>Permissions come from Midgard's group system</li></ul>An important consideration is also that the lack of file system access makes Midgard much more secure, as noted by <a href="http://www.midgard-project.org/community/whoswho/ab.html" title="Alexander Bokovoy, Midgard and Samba developer">Alexander Bokovoy</a> in his <a title="Midgard 5th anniversary" href="http://www.midgard-project.org/updates/midgard-5th-anniversary.html">Midgard 5th anniversary</a> presentation. When the whole system accesses only the database, and even that only through the Midgard libraries, this cuts down the risk of security holes through bad coding. In its 5 years of history, there hasn't been a since publicized security hole in Midgard. And this even though many high-profile hacking targets like large organizations, military, financial institutions and governments run Midgard.<br /><h2>Changing deployment models</h2>Back with Midgard 1.4.0 almost all Midgard applications were built in-house and were not distributed. This way version control of the code was more closely connected with the general staging/live routines of the developers. For this the fact that code could be replicated with content was advantageous.<br /><br />Now most applications like MidCOM and its components are being developed in centralized fashion by the Midgard Community. In this setup code is developed and tested on separate systems, and then release versions are deployed widely across production servers. This way version control of the code between a content staging and live is not so important, as both will share the same component versions, and will differ only in versions of templates, configuration and local code.<br /><h2>Separated concepts</h2>Moving MidCOM to file system not only makes development easier, but will also make the separation of centralized "system" code and local scripts clearer. MidCOM and its components are a part of the Midgard Framework, and are installed by the system administrator and not modified by a site developer. The things that a site developer will modify will be local and specific to a website, organization or a server environment, and so are stored into the Midgard database. This includes local configurations, output templates and local scripts.<br /><h2>The new way</h2>If mRFC 0006 gets implemented, all MidCOM core code and components will be developed just like any PHP application, using the file system and <a href="http://fi2.php.net/include/" title="PHP include() function">include()</a> statements. This means that version control and development will become substantially simpler.<br /><br />However, what we lose there is the ability to install a whole MidCOM component or the framework from a single repligard .xml.gz file. I have proposed using the <a href="http://pear.php.net/" title="PEAR - PHP Library Archive">PEAR</a> installer for this, and Torben has promised to include it to the mRFC.<br /><br />The PEAR installer uses an <a title="PEAR package.xml" href="http://pear.php.net/manual/en/developers.packagedef.php">XML configuration file</a> for defining the files shipping with a package, and enables server administrators to install new software with a single, Debian APT-like command regardless of the operating system. The <a title="PEAR installer documentation" href="http://pear.php.net/manual/en/installation.cli.php">PEAR installer</a> is available by default on PHP 4.3.0 and newer releases.<br /><br />Using the common PHP installation methods of the PEAR community would make The Midgard Project far better connected with the PHP community in general and promote code sharing.<br /><br />To promote this even further, the Midgard Community should fully embrace the <a title="PEAR Coding Standards" href="http://pear.php.net/manual/en/standards.php">PEAR Coding Standards</a>, and use the same code documentation tools.<br /><br />Theoretically MidCOM <a title="MidCOM fits the PEAR criteria of applicable packages" href="http://pear.php.net/manual/en/newmaint.when-to-contribute.php">could even move</a> to the <a title="PEAR Package List" href="http://pear.php.net/packages.php">PEAR repository</a>, but it would probably be seen as too Midgard-specific by the PEAR community. It provides a quite generic component architecture, but all components and its methods like the URL parser depend heavily on the midgard-php extension.<br /><h2>mRFC status</h2>Torben has still left the proposal to Draft state, and some things will have to be polished before it can be voted on.<br /><br />If the mRFC passes the actual transition should be relatively simple. We can just use the Aegir FileSync AddOn to copy all code snippets of the MidCOM core and component directories to the file system, and then programmatically change all <a href="http://www.midgard-project.org/documentation/reference/snippet/functions/mgd_include_snippet.html" title="PHP mgd_include_snippet() function">mgd_include_snippet()</a> calls in the system to use MidCOM's internal $midcom-&gt;include() method.<br /><br />The PEAR package description files should be easy to generate automatically. In addition, we should create a "MidCOM uninstaller" Repligard file that would include delete calls for all objects in the MidCOM 1.4.0 release.<br /><br />The actual MidCOM sites will be easy to migrate, as most of them contain only a single <a title="Explanation of the MidCOM program flow" href="http://www.midgard-project.org/documentation/concepts/midcom/specs/architecture/flow.html">mgd_include_snippet("/midcom/midcom")</a> call. This could be either changed to a filesystem require() call, or the MidCOM system could ship a stub snippet for this.
<p><span style="font-weight: bold;">Updated 13:20:</span> There is some discussion about this on the <a href="http://marc.theaimsgroup.com/?t=109463990400001&r=1&w=2" title="Discussion on mRFC 0006 on midgard-dev">midgard-dev mailing list</a>.</p>

<p>
<strong>Updated 2004-10-28:</strong> The vote on <a href="http://www.midgard-project.org/community/development/mrfc/0006.html">mRFC 0006</a> passed today, so we can finally start implementation.
</p>
